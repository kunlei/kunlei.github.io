<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.550">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Kunlei Lian - Resume</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-DJ30KLH89M"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-DJ30KLH89M', { 'anonymize_ip': true});
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Kunlei Lian</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./about.html" aria-current="page"> 
<span class="menu-text">Resume</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./docs/blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-books" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Books</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-books">    
        <li>
    <a class="dropdown-item" href="https://kunlei.github.io/python-ortools-notes/"><i class="bi bi-book" role="img">
</i> 
 <span class="dropdown-text">OR-Tools</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://kunlei.github.io/large-scale-opt-python/"><i class="bi bi-book" role="img">
</i> 
 <span class="dropdown-text">Large-Scale Optimization</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="https://kunlei.github.io/approaching-vrp-java/"><i class="bi bi-book" role="img">
</i> 
 <span class="dropdown-text">Approaching VRPs</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#education" id="toc-education" class="nav-link active" data-scroll-target="#education">Education</a></li>
  <li><a href="#experience" id="toc-experience" class="nav-link" data-scroll-target="#experience">Experience</a></li>
  <li><a href="#patents" id="toc-patents" class="nav-link" data-scroll-target="#patents">Patents</a></li>
  <li><a href="#publications" id="toc-publications" class="nav-link" data-scroll-target="#publications">Publications</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Resume</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="education" class="level3">
<h3 class="anchored" data-anchor-id="education">Education</h3>
<div class="d-flex justify-content-between">
<div>
<p><strong>University of Arkasnas</strong><br>
Ph.D.&nbsp;in Industrial Engineering</p>
</div>
<div class="text-end">
<p>Fayetteville, Arkansas<br>
2012 - 2017</p>
</div>
</div>
<ul>
<li>Dissertation: <a href="https://scholarworks.uark.edu/etd/1912/"><em>Service Consistency in Vehicle Routing</em></a> <!-- - Developed an enhanced multi-directional local search algorithm for approximating Pareto frontiers in multi-objective optimization, effectively solving the consistent vehicle routing problems (ConVRP).
- Developed a large neighborhood search and a branch-and-price algorithm to solve the ConVRP to minimize traveling costs. --></li>
</ul>
<div class="d-flex justify-content-between">
<div>
<p><strong>Huazhong University of Science and Technology</strong><br>
M.S. in Industrial Engineering</p>
</div>
<div class="text-end">
<p>Wuhan, China 2009 - 2012</p>
</div>
</div>
<div class="d-flex justify-content-between">
<div>
<p><strong>Huazhong University of Science and Technology</strong><br>
B.S. in Industrial Engineering</p>
</div>
<div class="text-end">
<p>Wuhan, China 2005 - 2009</p>
</div>
</div>
</section>
<section id="experience" class="level3">
<h3 class="anchored" data-anchor-id="experience">Experience</h3>
<div class="d-flex justify-content-between">
<div>
<p><strong>Marriott Vacations Worldwide</strong></p>
</div>
<div class="text-end">
<p>October 2023 - present</p>
</div>
</div>
<p><em>Principal Data Scientist / Associate Director - Data Science</em></p>
<ul>
<li>Marketing campaign optimization</li>
<li>Owner propensity to buy</li>
<li>Inventory optimization</li>
</ul>
<div class="d-flex justify-content-between">
<div>
<p><strong>Walmart</strong></p>
</div>
<div class="text-end">
<p>May 2016 - August 2023</p>
</div>
</div>
<p><em>Principal Data Scientist</em></p>
<ul>
<li>Oversaw all order optimization initiatives for Walmart grocery and regional distribution center (GDC&amp;RDC) network as principal data scientist, focusing on improving efficiencies in GDC&amp;RDC inbound and outbound replenishment operations.</li>
<li>Led the development of truckload optimization (TLO) engine as the core of the next-gen inbound replenishment system that optimizes order quantities from vendors to DCs, enabled its rollout to 10,000+ lanes to replace legacy TLO.</li>
<li>Designed and implemented a truck planning optimization (TPO) engine to smooth ship point volumes and reduce unplanned truck needs, anticipating a $9 million reduction in transportation costs for Q4 2023.</li>
<li>Built an outbound order optimization (O3) engine using mixed-integer programming (MIP) and linear regression for GDCs and RDCs to smooth store inbound volumes, improve truck arrival time consistency and facilitate store labor planning.</li>
<li>Devised a network planning model employing integer programming (IP) and K-means clustering to optimize shipment consolidation efficiency for Walmart’s largest inbound transportation network.</li>
<li>Tech stack: Python, Java, Google OR-Tools, CPLEX | IP, MIP, Heuristics, Linear regression, Clustering</li>
</ul>
<p><em>Staff Data Scientist</em></p>
<ul>
<li>Designed and implemented a cloud-based distributed shipment consolidation engine for Walmart’s high-volume inbound transportation network, optimizing 100,000+ shipments during peak periods. It consists of a heuristic-driven partition engine to segment the network, a column generation-based consolidation engine that iteratively identifies cost-effective candidate loads, and a MIP-based picking engine for final load selection. Realized $1 million monthly transportation cost reductions in 2023, with progress toward replacing the current industry-leading commercial solver.</li>
<li>Developed a rapid heuristic algorithm for solving the fixed sequence 3D bin packing problem in GDC pallet building process, addressing the 6-month learning curve and high turnover rates for new hires. Attained an average of 20s for full pallet building with 100+ heterogeneous cases, yielding 85+% packing efficiency and 80+% pallet stability. Conducted successful pilots in 2 GDCs, revealing a 70% decrease in the learning curve and an anticipated $10 million yearly savings if used across all GDCs.</li>
<li>Assisted the global logistics team in selecting optimal ocean carriers and reducing total transportation costs, resulting in a cost reduction of $90 million during the challenging disruptions of the COVID-19 impacted global supply chain in fiscal year 2021.</li>
<li>Tech stack: Java, CPLEX, SpringBoot Microservices | Column Generation, MIP, Vehicle Routing/Bin Packing Heuristics</li>
</ul>
<p><em>Senior Data Scientist</em></p>
<ul>
<li>Conceptualized and developed a profiling application prototype, enabling GDCs to attain optimal item-to-slot assignments. Participated in end-to-end system development encompassing both frontend and backend components.</li>
<li>Overhauled legacy MIP-based optimization engine for optimal carrier and load quantity determination in Walmart’s ocean procurement during fiscal year 2020. Strengthened modeling capabilities and constraint adaptability to encompass operational and strategic factors. Offered on-site optimization support across numerous bidding cycles, resulting in $30 million operational cost savings, noteworthy labor hour reduction, and heightened stability within the Walmart supply chain.</li>
<li>Tech Stack: Java, JavaScript | MIP, Heuristics</li>
</ul>
<p><em>Data Scientist</em></p>
<ul>
<li>Constructed a column-generation-driven optimization engine in a rolling horizon framework, focusing on assigning drivers to tractors to optimize tractor utilization and reduce driver split-seat instances. Generated $4 million labor cost savings and $8 million operational cost savings annually through this approach.</li>
<li>Implemented a column-generation-based optimization engine to estimate store-level customer purchase probability based on historical transaction data. Built a MIP engine to decide optimal offer set for each category at store level.</li>
<li>Migrated legacy truckload optimization COBOL code to Java, reducing data processing time from 10 minutes to 10 seconds. Developed heuristic algorithms to solve instances with large number of orders, resulting in a daily reduction of 14 trucks.</li>
<li>Tech stack: Java, COBOL | Column Generation, MIP, Heuristics</li>
</ul>
<p><em>Global Business Process Intern</em></p>
<ul>
<li>Contributed to the implementation and validation of next generation inventory optimization model for Walmart U.S., yielding an 8% improvement over the existing system in pilot store trials. Spearheaded the data platform migration from Teradata to Hadoop, implementing data ETL processes and Hive queries.</li>
</ul>
</section>
<section id="patents" class="level3">
<h3 class="anchored" data-anchor-id="patents">Patents</h3>
<div class="d-flex justify-content-between">
<div>
<p><strong>Load Builder Optimizer using a Column Generation Engine</strong><br>
<em>Kunlei Lian</em>, Ming Ni, Mingang Fu</p>
</div>
<div class="text-end">
<p>2023</p>
</div>
</div>
<p>This patent presents a column generation-based optimization engine to solve shipment pickup and delivery problems. It aims to consolidate hundreds of thousands of shipments on a daily basis over Walmart’s vast inbound network and move them from their origins to their corresponding destinations while utilizing consolidation center capacities as much as possible to save transportation costs.</p>
<div class="d-flex justify-content-between">
<div>
<p><strong>Systems and Methods for Driver Scheduling</strong><br>
<em>Kunlei Lian</em>, Ming Ni, Mingang Fu</p>
</div>
<div class="text-end">
<p>2022</p>
</div>
</div>
<p>This patent introduces a column generation-based rolling horizon optimization engine that optimizes the assignment of drivers to tractors. This critical process significantly influences operational efficiency and costs within the Walmart private fleet. The solution is able to minimize the split-seats among drivers while maximizing tractor utilization.</p>
<div class="d-flex justify-content-between">
<div>
<p><strong>Systems and Methods for Safety Stock Settings Using a Parallel Processing Computing Architecture</strong><br>
Shuohao Wu, Richard Ulrich, Dong Xu, Jingying Zhang, <em>Kunlei Lian</em>, Clifford Bolinger, Jackie Guan</p>
</div>
<div class="text-end">
<p>2020</p>
</div>
</div>
<p>This patent features a Monte Carlo simulation-based stochastic optimization engine that employs GPU computing to optimize safety stock level settings across the chain, achieving reduced total inventory costs without impacting overall sales.</p>
</section>
<section id="publications" class="level3">
<h3 class="anchored" data-anchor-id="publications">Publications</h3>
<ul>
<li>Chang Lv, Chaoyong Zhang, Kunlei Lian, Yaping Ren and Leilei Meng. A two-echelon fuzzy clustering based heuristic for large-scale bike sharing repositioning problem. Transportation Research Part B: Methodological 160 (2022): 54-75.</li>
<li>Jianzhao Wu, Kunlei Lian, Yelin Deng, Ping Jiang and Chaoyong Zhang. Multi-Objective Parameter Optimization of Fiber Laser Welding Considering Energy Consumption and Bead Geometry. IEEE Transactions on Automation Science and Engineering vol.&nbsp;19 issue 4 (2021): 3561-3574</li>
<li>Chunjiang Zhang, Jiawei Tan, Kunkun Peng, Liang Gao, Weiming Shen, Kunlei Lian. A discrete whale swarm algorithm for a hybrid flow-shop scheduling problem with limited buffers. Robotics and Computer-Integrated Manufacturing (2020).</li>
<li>Chang Lv, Chaoyong Zhang, Kunlei Lian, Yaping Ren, and Leilei Meng. A hybrid algorithm for the static bike-sharing re-positioning problem based on an effective clustering strategy. Transportation Research Part B: Methodological 140 (2020): 1-21.</li>
<li>Yang Xie, Kunlei Lian, Qiong Liu, Chaoyong Zhang, and Hongqi Liu. Digital twin for cutting tool: Modeling, application and service strategy. Journal of Manufacturing Systems (2020).</li>
<li>Chunjiang Zhang, Yin Zhou, Kunkun Peng, Xinyu Li, Kunlei Lian, and Suyan Zhang. Dynamic flexible job shop scheduling method based on improved gene expression programming. Measurement and Control (2020).</li>
<li>Kunlei Lian, Ashlea Bennett Milburn, and Ronald L. Rardin. An improved multi-directional local search algorithm for the multi-objective consistent vehicle routing problem. IIE Transactions 48, no. 10 (2016): 975-992.</li>
<li>Chuanjun Zhu, Jing Cao, Chaoyong Zhang, Kunlei Lian. Applying modified colonial competitive algorithm to solve minimal hitting set problems. China Mechanical Engineering 26, no. 7 (2015): 917-923</li>
<li>Kunlei Lian, Chaoyong Zhang, Liang Gao, and Xinyu Shao. A modified colonial competitive algorithm for the mixed-model U-line balancing and sequencing problem. International Journal of Production Research 50, no. 18 (2012): 5117-5131.</li>
<li>Kunlei Lian, Chaoyong Zhang, Liang Gao, and Xinyu Li. Integrated process planning and scheduling using an imperialist competitive algorithm. International Journal of Production Research 50, no. 15 (2012): 4326-4343.</li>
<li>Kunlei Lian, Chaoyong Zhang, Xinyu Shao, and Liang Gao. Optimization of process planning with various flexibilities using an imperialist competitive algorithm. The International Journal of Advanced Manufacturing Technology 59, no. 5-8 (2012): 815-828.</li>
<li>KunLei Lian, ChaoYong Zhang, XinYu Shao, and YaoHui Zeng. A multi-dimensional tabu search algorithm for the optimization of process planning. Science China Technological Sciences 54, no. 12 (2011): 3211-3219.</li>
<li>Kun Zhang, Hui Liu, and Kunlei Lian. Application of bee colony optimization algorithm in warehouse facility location of rail transit network. Modern Urban Transit 1, (2011): 63-66</li>
<li>Fuping Deng, Chaoyong Zhang, kunlei Lian and Shaotan Xu. An adaptive ant colony optimization for solving assembly line balancing problem. China Mechanical Engineering 22, no. 16 (2011):1949-1953, 1959.</li>
<li>Kunlei Lian, Chaoyong Zhang, Liang Gao, Shaotan Xu, and Yi Sun. A cooperative simulated annealing algorithm for the optimization of process planning. In Advanced Materials Research, vol.&nbsp;181, pp.&nbsp;489-494. Trans Tech Publications Ltd, 2011.</li>
<li>Kunlei Lian, Chaoyong Zhang, Liang Gao and Chaoyang Zhang. An improved genetic algorithm for multi-objective dynamic scheduling optimization. Machine Design and Manufacturing Engineering 39, no. 3 (2010):13-17, 21</li>
</ul>
<!-- ### Publications

#### Facebook
::: {.d-flex .justify-content-between}
::: {}
test
:::
::: {.text-end}
2011-2022
:::
::: -->


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>